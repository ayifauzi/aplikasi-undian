<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aplikasi Undian 72 Peserta</title>
    <style>
      :root {
        --bg: #071428;
        --card: #0f2540;
        --accent: #ffd166;
        --muted: #9fb4c8;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 10% 10%, #081229 0%, #041018 40%), linear-gradient(180deg, #071428 0%, #03202a 100%);
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        color: #fff;
        padding: 24px;
      }
      .wrap {
        width: 100%;
        max-width: 1000px;
        text-align: center;
      }
      h1 {
        font-size: 34px;
        margin: 6px 0 18px;
        letter-spacing: 1px;
      }
      .stage {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
        padding: 28px;
        border-radius: 18px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        position: relative;
      }
      #display {
        font-size: 120px;
        font-weight: 800;
        line-height: 1;
        padding: 40px;
        border-radius: 16px;
        background: linear-gradient(90deg, #071622, #0b2b3f);
        display: inline-block;
        min-width: 260px;
        min-height: 170px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6), 0 0 40px rgba(255, 209, 102, 0.05);
        transform-origin: center;
        transition: transform 0.25s ease;
      }
      .reveal {
        animation: pop 0.8s cubic-bezier(0.2, 0.9, 0.3, 1) forwards;
      }
      @keyframes pop {
        0% {
          transform: scale(0.85);
          filter: blur(6px);
          opacity: 0.6;
        }
        60% {
          transform: scale(1.08);
          filter: blur(0);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .controls {
        margin-top: 18px;
      }
      button {
        font-size: 18px;
        padding: 12px 22px;
        margin: 6px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 700;
      }
      #startBtn {
        background: linear-gradient(90deg, #06d6a0, #06b58f);
        color: #052017;
      }
      #resetBtn {
        background: linear-gradient(90deg, #ff6b6b, #ff3b3b);
        color: white;
      }
      #sampleBtn {
        background: linear-gradient(90deg, #4d8cff, #2a63d6);
        color: white;
      }
      .meta {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: center;
        margin-top: 14px;
      }
      .badge {
        background: rgba(255, 255, 255, 0.03);
        padding: 8px 12px;
        border-radius: 999px;
        color: var(--muted);
      }
      .history {
        margin-top: 18px;
        text-align: left;
        display: flex;
        gap: 20px;
      }
      .history .col {
        flex: 1;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
        padding: 14px;
        border-radius: 10px;
        min-height: 120px;
      }
      .history h3 {
        margin: 0 0 8px;
        font-size: 16px;
      }
      .list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .pill {
        background: rgba(255, 255, 255, 0.06);
        padding: 8px 10px;
        border-radius: 8px;
        font-weight: 700;
      }
      canvas#confetti {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        border-radius: 18px;
      }
      @media (max-width: 700px) {
        #display {
          font-size: 72px;
          padding: 24px;
          min-height: 120px;
        }
      }
      .header img {
        display: block;
        margin: 0 auto 8px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="stage">
        <canvas id="confetti"></canvas>
        <div class="header" style="margin-bottom: 20px">
          <img src="logo1.png" alt="Logo PGRI" style="width: 130px; margin-bottom: 12px; filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.3))" />
          <h1 style="font-size: 36px; margin: 4px 0 6px; letter-spacing: 1px; color: #ffd166; text-shadow: 0 0 8px rgba(255, 209, 102, 0.4)">HUT ke-80 PGRI Tahun 2025</h1>
          <h2 style="margin: 0; font-weight: 400; font-size: 20px; color: #d8e3f0; letter-spacing: 0.5px">Undian 1–72 — Hari Guru Nasional</h2>
        </div>

        <div id="display">--</div>

        <div class="controls">
          <button id="startBtn">Mulai Undian</button>
          <button id="sampleBtn">Coba (uji coba)</button>
          <button id="resetBtn">Reset</button>
        </div>

        <div class="meta">
          <div class="badge" id="remaining">Sisa nomor yang belum keluar: 72</div>
          <div class="badge" id="lastPicked">Terakhir: —</div>
        </div>

        <div class="history" style="margin-top: 18px">
          <div class="col">
            <h3>Riwayat (dari yang pertama keluar)</h3>
            <div id="historyList" class="list" aria-live="polite"></div>
          </div>
          <div class="col">
            <h3>Instruksi singkat</h3>
            <div style="color: var(--muted); font-size: 14px">
              Tekan <strong>Mulai Undian</strong> untuk mulai. Selama animasi, terdengar bunyi "tick". Setelah berhenti, nomor yang terpilih akan muncul dan ditambahkan ke riwayat. Gunakan <strong>Reset</strong> untuk mengembalikan ke
              kondisi awal sebelum acara. Tombol <strong>Coba (uji coba)</strong> hanya mengacak beberapa kali tanpa menghapus nomor dari daftar, berguna saat latihan.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // State
      let peserta = [];
      let rolling = false;
      let interval = null;

      // DOM
      const display = document.getElementById("display");
      const remainingBadge = document.getElementById("remaining");
      const lastPicked = document.getElementById("lastPicked");
      const historyList = document.getElementById("historyList");
      const startBtn = document.getElementById("startBtn");
      const resetBtn = document.getElementById("resetBtn");
      const sampleBtn = document.getElementById("sampleBtn");

      // Audio using WebAudio API (no external files needed)
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function tickSound(vol = 0.02, freq = 880, duration = 0.06) {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "sine";
        o.frequency.value = freq;
        g.gain.value = vol;
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
        o.stop(audioCtx.currentTime + duration + 0.02);
      }
      function chime() {
        const freqs = [660, 880, 1100];
        const duration = 0.6;
        freqs.forEach((f, i) => {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = "sine";
          o.frequency.value = f;
          g.gain.value = 0.02;
          o.connect(g);
          g.connect(audioCtx.destination);
          o.start(audioCtx.currentTime + i * 0.06);
          g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + i * 0.06 + duration);
          o.stop(audioCtx.currentTime + i * 0.06 + duration + 0.05);
        });
      }

      // Confetti simple implementation
      const confettiCanvas = document.getElementById("confetti");
      const ctx = confettiCanvas.getContext("2d");
      let confettiPieces = [];
      function resizeCanvas() {
        confettiCanvas.width = confettiCanvas.clientWidth * devicePixelRatio;
        confettiCanvas.height = confettiCanvas.clientHeight * devicePixelRatio;
        ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      function spawnConfetti() {
        confettiPieces = [];
        const colors = ["#ffd166", "#06d6a0", "#118ab2", "#ef476f"];
        for (let i = 0; i < 80; i++) {
          confettiPieces.push({
            x: Math.random() * confettiCanvas.clientWidth,
            y: -Math.random() * 400,
            w: 6 + Math.random() * 10,
            h: 6 + Math.random() * 6,
            vx: -2 + Math.random() * 4,
            vy: 2 + Math.random() * 6,
            r: Math.random() * 360,
            color: colors[Math.floor(Math.random() * colors.length)],
            rotSpeed: -6 + Math.random() * 12,
          });
        }
        requestAnimationFrame(drawConfetti);
      }
      function drawConfetti() {
        ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        confettiPieces.forEach((p) => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.08;
          p.r += p.rotSpeed;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate((p.r * Math.PI) / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
          ctx.restore();
        });
        confettiPieces = confettiPieces.filter((p) => p.y < confettiCanvas.clientHeight + 50);
        if (confettiPieces.length > 0) requestAnimationFrame(drawConfetti);
      }

      // --- Save & Load State (localStorage) ---
      function saveState() {
        const state = {
          peserta: peserta,
          history: Array.from(document.querySelectorAll("#historyList .pill")).map((p) => p.innerText),
          last: lastPicked.innerText,
          display: display.innerText,
        };
        localStorage.setItem("undianState", JSON.stringify(state));
      }

      function loadState() {
        const raw = localStorage.getItem("undianState");
        if (!raw) return false;
        try {
          const s = JSON.parse(raw);
          peserta = Array.isArray(s.peserta) ? s.peserta : [];
          historyList.innerHTML = "";
          (s.history || []).forEach((num) => {
            const d = document.createElement("div");
            d.className = "pill";
            d.innerText = num;
            historyList.appendChild(d);
          });
          lastPicked.innerText = s.last || "Terakhir: —";
          display.innerText = s.display || "--";
          updateBadges();
          return true;
        } catch (e) {
          console.log("Load error", e);
          return false;
        }
      }

      // --- Buttons
      const saveBtn = document.createElement("button");
      saveBtn.id = "saveBtn";
      saveBtn.innerText = "Simpan Hasil";
      saveBtn.style.background = "linear-gradient(90deg,#ffa600,#ff7b00)";
      saveBtn.style.color = "white";
      document.querySelector(".controls").appendChild(saveBtn);
      saveBtn.addEventListener("click", () => {
        saveState();
        alert("Hasil disimpan ke browser (localStorage).");
      });

      // Init
      // First try to load previous state; if none, initialize full peserta list
      const loaded = loadState();
      if (!loaded) initPeserta();

      function initPeserta() {
        peserta = [];
        for (let i = 1; i <= 72; i++) peserta.push(i);
        updateBadges();
        historyList.innerHTML = "";
        display.innerText = "--";
        lastPicked.innerText = "Terakhir: —";
      }

      function updateBadges() {
        remainingBadge.innerText = "Sisa nomor yang belum keluar: " + peserta.length;
      }

      function addToHistory(num) {
        const pill = document.createElement("div");
        pill.className = "pill";
        pill.innerText = num;
        historyList.appendChild(pill);
      }

      // Main start function
      async function startUndian() {
        if (rolling) return;
        if (peserta.length === 0) {
          alert("Semua nomor sudah keluar. Tekan Reset jika ingin mulai ulang.");
          return;
        }
        if (audioCtx.state === "suspended") await audioCtx.resume();

        rolling = true;
        display.classList.remove("reveal");

        interval = setInterval(() => {
          const acak = peserta[Math.floor(Math.random() * peserta.length)];
          display.innerText = acak;
          tickSound(0.01, 900, 0.04);
          display.style.transform = `scale(${1 + Math.random() * 0.06})`;
        }, 70);

        setTimeout(() => {
          clearInterval(interval);
          const index = Math.floor(Math.random() * peserta.length);
          const terpilih = peserta[index];
          peserta.splice(index, 1);
          display.innerText = terpilih;
          display.classList.add("reveal");
          display.style.transform = "scale(1)";
          addToHistory(terpilih);
          lastPicked.innerText = "Terakhir: " + terpilih;
          updateBadges();
          chime();
          spawnConfetti();
          rolling = false;
          // auto-save after pick
          saveState();
        }, 2600);
      }

      // Sample (uji coba) — animates but does NOT remove the item from the pool
      function sampleRun() {
        if (rolling) return;
        if (audioCtx.state === "suspended") audioCtx.resume();
        rolling = true;
        let times = 18 + Math.floor(Math.random() * 12);
        let count = 0;
        interval = setInterval(() => {
          const acak = 1 + Math.floor(Math.random() * 72);
          display.innerText = acak;
          tickSound(0.008, 900 - count * 6, 0.04);
          count++;
          if (count >= times) {
            clearInterval(interval);
            display.classList.add("reveal");
            chime();
            setTimeout(() => {
              display.classList.remove("reveal");
              rolling = false;
            }, 800);
          }
        }, 60);
      }

      // Reset function
      function resetAll() {
        if (rolling && !confirm("Proses undian sedang berjalan. Anda yakin ingin menghentikan dan mereset?")) return;
        if (interval) {
          clearInterval(interval);
          interval = null;
        }
        rolling = false;
        confettiPieces = [];
        ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
        historyList.innerHTML = "";
        display.classList.remove("reveal");
        display.style.transform = "scale(1)";
        display.innerText = "--";
        lastPicked.innerText = "Terakhir: —";
        initPeserta();
        // clear saved state too
        localStorage.removeItem("undianState");
      }

      // Attach events
      startBtn.addEventListener("click", startUndian);
      sampleBtn.addEventListener("click", sampleRun);
      resetBtn.addEventListener("click", resetAll);
    </script>
  </body>
</html>
